"""
737 MAX 8 N1 Takeoff Tables for Infinite Flight
Includes:
  - MAX / TO1 / TO2 manufacturer tables
  - PACKS OFF altitude deltas
  - Engine Anti-Ice ON altitude deltas
  - Bilinear interpolation
  - IF slider mapping (20% N1 → slider 0%, 101% N1 → slider 100%)
"""

from typing import List, Dict
import bisect

# --------------------------------------------------------------------
# AXES: Altitude (kft) & Temperature (°C)
# --------------------------------------------------------------------
ALT_COLS_KFT: List[float] = [-2, -1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 14.5]
TEMP_ROWS_C: List[int] = [-50, -45, -40, -35, -30, -25, -20, -15, -10, -5,
                           0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60]


# --------------------------------------------------------------------
# UTILS — Interpolation
# --------------------------------------------------------------------
def _interp1(x, x0, x1, y0, y1):
    if x1 == x0:
        return y0
    t = (x - x0) / (x1 - x0)
    return y0 + (y1 - y0) * t

def _locate(axis: List[float], x: float):
    if x <= axis[0]:
        return 0, 0, axis[0], axis[0]
    if x >= axis[-1]:
        j = len(axis)-1
        return j, j, axis[j], axis[j]
    i1 = bisect.bisect_right(axis, x)
    i0 = i1 - 1
    return i0, i1, axis[i0], axis[i1]

def _bilinear(rows: Dict[int, List[float]], A_ft: float, T_c: float) -> float:
    # locate temp
    r0, r1, T0, T1 = _locate(TEMP_ROWS_C, T_c)
    # locate altitude
    c0, c1, A0, A1 = _locate(ALT_COLS_KFT, A_ft/1000.0)

    Q11 = rows[T0][c0]
    Q21 = rows[T0][c1]
    Q12 = rows[T1][c0]
    Q22 = rows[T1][c1]

    if T1 == T0 and A1 == A0:
        return Q11
    if T1 == T0:
        return _interp1(A_ft/1000.0, A0, A1, Q11, Q21)
    if A1 == A0:
        return _interp1(T_c, T0, T1, Q11, Q12)

    fA_T0 = _interp1(A_ft/1000.0, A0, A1, Q11, Q21)
    fA_T1 = _interp1(A_ft/1000.0, A0, A1, Q12, Q22)
    return _interp1(T_c, T0, T1, fA_T0, fA_T1)


def _interp_altitude_delta(delta_list: List[float], A_ft: float):
    """Interpolate PACKS/A-ICE altitude-based delta."""
    c0, c1, A0, A1 = _locate(ALT_COLS_KFT, A_ft/1000.0)
    y0 = delta_list[c0]
    y1 = delta_list[c1]
    if A1 == A0:
        return y0
    return _interp1(A_ft/1000.0, A0, A1, y0, y1)


# --------------------------------------------------------------------
# FULL MANUFACTURER TABLES (MAX, TO1, TO2)
# --------------------------------------------------------------------

MAX_ROWS = {
    60: [85.6,86.1,86.6,86.7,86.2,85.7,85.2,84.8,84.3,83.9,83.5,83.0,82.5,81.6,80.6,79.5,78.6,78.2],
    55: [86.9,87.3,87.7,87.8,87.4,86.9,86.4,85.9,85.5,85.1,84.6,84.2,83.7,82.7,81.8,80.7,79.8,79.4],
    50: [88.0,88.6,89.2,88.8,88.4,88.0,87.5,87.1,86.6,86.2,85.8,85.3,84.8,83.9,83.0,81.9,81.0,80.6],
    45: [88.9,89.5,90.0,89.9,89.5,88.9,88.6,88.2,87.7,87.3,86.9,86.4,86.0,85.0,84.1,83.0,82.2,81.7],
    40: [89.9,90.4,91.0,90.9,90.9,90.6,89.9,89.1,88.7,88.3,88.0,87.5,87.0,86.1,85.2,84.1,83.3,82.8],
    35: [90.7,91.3,91.9,91.9,91.8,91.7,91.6,91.3,90.7,89.7,88.9,88.5,88.1,87.2,86.3,85.3,84.4,84.0],
    30: [90.2,91.5,92.8,92.6,92.6,92.6,92.5,92.4,92.4,92.2,89.8,89.5,89.1,88.2,87.4,86.4,85.6,85.2],
    25: [89.4,90.7,92.0,92.3,92.7,92.8,92.9,93.2,93.0,93.0,90.8,90.4,90.0,89.2,88.4,87.6,86.7,86.3],
    20: [88.6,89.9,91.2,91.5,91.8,92.1,92.5,92.8,93.0,93.1,91.7,91.3,91.0,90.2,89.5,88.7,87.9,87.5],
    15: [87.8,89.1,90.4,90.7,91.0,91.3,91.6,91.9,92.3,92.6,92.7,92.4,92.0,91.2,90.5,89.8,89.0,88.7],
    10: [87.0,88.3,89.6,89.9,90.2,90.5,90.8,91.1,91.5,91.8,92.2,92.6,93.0,92.2,91.6,90.9,90.2,89.9],
     5: [86.2,87.5,88.8,89.1,89.4,89.7,90.0,90.3,90.7,91.0,91.4,91.8,92.2,92.2,92.2,92.0,91.4,91.1],
     0: [85.4,86.7,87.9,88.3,88.6,88.9,89.2,89.5,89.8,90.2,90.6,91.0,91.4,91.4,91.5,91.5,91.5,91.6],
    -5: [84.6,85.8,87.1,87.4,87.8,88.0,88.3,88.7,89.0,89.4,89.8,90.2,90.5,90.6,90.7,90.7,90.7,90.8],
   -10: [83.8,85.0,86.3,86.6,86.9,87.2,87.5,87.8,88.1,88.5,88.9,89.3,89.7,89.8,89.8,89.9,89.9,89.9],
   -15: [83.0,84.2,85.5,85.8,86.1,86.3,86.6,86.9,87.3,87.7,88.1,88.5,88.9,89.0,89.0,89.1,89.1,89.1],
   -20: [82.2,83.4,84.6,84.9,85.2,85.5,85.7,86.1,86.4,86.8,87.3,87.7,88.1,88.1,88.2,88.2,88.3,88.3],
   -25: [81.4,82.6,83.8,84.1,84.4,84.7,84.9,85.2,85.6,86.0,86.4,86.8,87.2,87.3,87.4,87.4,87.4,87.5],
   -30: [80.5,81.8,83.0,83.3,83.6,83.8,84.1,84.4,84.7,85.1,85.5,86.0,86.4,86.5,86.5,86.6,86.6,86.6],
   -35: [79.7,80.9,82.1,82.4,82.7,83.0,83.2,83.5,83.9,84.3,84.7,85.1,85.5,85.6,85.6,85.7,85.8,85.8],
   -40: [78.9,80.1,81.2,81.6,81.8,82.1,82.4,82.7,83.0,83.4,83.8,84.2,84.6,84.7,84.7,84.8,84.9,84.9],
   -45: [78.0,79.2,80.4,80.7,81.0,81.2,81.5,81.8,82.1,82.5,82.9,83.3,83.7,83.8,83.8,83.9,84.0,84.0],
   -50: [77.2,78.3,79.5,79.8,80.1,80.3,80.6,80.9,81.3,81.6,82.0,82.4,82.7,82.8,82.9,83.0,83.1,83.2],
}

TO1_ROWS = {
    60: [81.9, 82.4, 82.9, 83.0, 82.5, 82.0, 81.6, 81.1, 80.7, 80.3, 79.8, 79.4, 78.9, 78.0, 77.1, 76.0, 75.5, 75.5],
    55: [83.3, 83.6, 84.1, 84.1, 83.7, 83.2, 82.7, 82.3, 81.9, 81.4, 81.0, 80.6, 80.1, 79.1, 78.2, 77.2, 76.3, 75.9],
    50: [84.3, 84.9, 85.5, 85.1, 84.8, 84.3, 83.8, 83.4, 83.0, 82.5, 82.1, 81.7, 81.2, 80.3, 79.4, 78.3, 77.5, 77.0],
    45: [85.2, 85.8, 86.3, 86.1, 85.7, 85.2, 84.9, 84.5, 84.1, 83.6, 83.2, 82.8, 82.3, 81.4, 80.5, 79.4, 78.6, 78.2],
    40: [86.1, 86.7, 87.2, 87.2, 87.1, 86.8, 86.2, 85.4, 85.1, 84.7, 84.3, 83.9, 83.4, 82.5, 81.6, 80.5, 79.7, 79.3],
    35: [86.9, 87.6, 88.1, 88.1, 88.0, 87.9, 87.8, 87.5, 86.9, 86.0, 85.2, 84.8, 84.4, 83.5, 82.7, 81.7, 80.8, 80.4],
    30: [86.5, 87.7, 89.0, 88.8, 88.8, 88.8, 88.7, 88.6, 88.5, 88.3, 86.1, 85.8, 85.4, 84.6, 83.7, 82.8, 82.0, 81.6],
    25: [85.7, 87.0, 88.2, 88.5, 88.9, 89.0, 89.0, 89.3, 89.2, 89.2, 87.0, 86.6, 86.3, 85.5, 84.7, 83.9, 83.1, 82.7],
    20: [84.9, 86.2, 87.4, 87.7, 88.0, 88.3, 88.6, 88.9, 89.1, 89.2, 87.9, 87.6, 87.2, 86.5, 85.7, 85.0, 84.2, 83.8],
    15: [84.2, 85.4, 86.6, 86.9, 87.2, 87.5, 87.8, 88.1, 88.5, 88.8, 88.9, 88.5, 88.2, 87.4, 86.7, 86.0, 85.3, 85.0],
    10: [83.4, 84.7, 85.9, 86.1, 86.4, 86.7, 87.1, 87.4, 87.7, 88.0, 88.4, 88.8, 89.1, 88.4, 87.8, 87.2, 86.5, 86.1],
     5: [82.7, 83.9, 85.1, 85.4, 85.7, 86.0, 86.3, 86.6, 86.9, 87.2, 87.6, 88.0, 88.3, 88.3, 88.4, 88.2, 87.6, 87.3],
     0: [81.9, 83.1, 84.3, 84.6, 84.9, 85.2, 85.5, 85.8, 86.1, 86.5, 86.8, 87.2, 87.6, 87.6, 87.7, 87.7, 87.7, 87.8],
    -5: [81.1, 82.3, 83.5, 83.8, 84.1, 84.4, 84.7, 85.0, 85.3, 85.6, 86.0, 86.4, 86.8, 86.8, 86.9, 86.9, 87.0, 87.0],
   -10: [80.3, 81.5, 82.7, 83.0, 83.3, 83.6, 83.8, 84.2, 84.5, 84.8, 85.2, 85.6, 86.0, 86.1, 86.1, 86.2, 86.2, 86.2],
   -15: [79.6, 80.7, 81.9, 82.2, 82.5, 82.8, 83.0, 83.3, 83.7, 84.0, 84.4, 84.9, 85.2, 85.3, 85.3, 85.4, 85.4, 85.4],
   -20: [78.8, 80.0, 81.1, 81.4, 81.7, 82.0, 82.2, 82.5, 82.8, 83.2, 83.6, 84.1, 84.4, 84.5, 84.5, 84.6, 84.6, 84.6],
   -25: [78.0, 79.2, 80.3, 80.6, 80.9, 81.2, 81.4, 81.7, 82.0, 82.4, 82.8, 83.2, 83.6, 83.7, 83.7, 83.8, 83.8, 83.8],
   -30: [77.2, 78.4, 79.5, 79.8, 80.1, 80.4, 80.6, 80.9, 81.2, 81.6, 82.0, 82.4, 82.8, 82.9, 82.9, 83.0, 83.0, 83.0],
   -35: [76.4, 77.6, 78.7, 79.0, 79.3, 79.5, 79.8, 80.1, 80.4, 80.8, 81.2, 81.6, 81.9, 82.0, 82.1, 82.2, 82.2, 82.2],
   -40: [75.6, 76.8, 77.9, 78.2, 78.5, 78.7, 79.0, 79.3, 79.6, 79.9, 80.3, 80.7, 81.1, 81.2, 81.2, 81.3, 81.4, 81.4],
   -45: [74.8, 75.9, 77.1, 77.3, 77.6, 77.9, 78.1, 78.4, 78.7, 79.1, 79.5, 79.9, 80.2, 80.3, 80.4, 80.5, 80.5, 80.6],
   -50: [74.0, 75.1, 76.2, 76.5, 76.8, 77.0, 77.3, 77.6, 77.9, 78.2, 78.6, 79.0, 79.3, 79.4, 79.5, 79.6, 79.7, 79.7],
}

TO2_ROWS = {
    60: [77.8, 78.3, 78.8, 78.9, 78.4, 78.0, 77.5, 77.1, 76.7, 76.3, 75.9, 75.5, 75.4, 75.4, 75.4, 75.4, 75.5, 75.5],
    55: [79.2, 79.6, 80.0, 80.1, 79.6, 79.1, 78.7, 78.2, 77.8, 77.3, 76.9, 76.5, 76.1, 75.2, 74.9, 74.9, 74.9, 74.9],
    50: [80.3, 80.8, 81.4, 81.1, 80.7, 80.3, 79.8, 79.4, 78.9, 78.5, 78.1, 77.7, 77.2, 76.3, 75.4, 74.4, 74.3, 74.3],
    45: [81.2, 81.8, 82.3, 82.1, 81.7, 81.2, 80.9, 80.5, 80.1, 79.6, 79.2, 78.8, 78.3, 77.4, 76.5, 75.4, 74.6, 74.2],
    40: [82.1, 82.7, 83.2, 83.1, 83.1, 82.8, 82.2, 81.4, 81.1, 80.7, 80.3, 79.9, 79.4, 78.5, 77.6, 76.6, 75.7, 75.3],
    35: [82.9, 83.5, 84.1, 84.1, 84.0, 83.9, 83.8, 83.5, 82.9, 82.0, 81.3, 80.9, 80.5, 79.6, 78.7, 77.7, 76.9, 76.5],
    30: [82.5, 83.7, 84.9, 84.7, 84.7, 84.7, 84.6, 84.6, 84.5, 84.3, 82.1, 81.8, 81.4, 80.6, 79.8, 78.9, 78.1, 77.7],
    25: [81.8, 83.0, 84.2, 84.5, 84.8, 84.9, 85.0, 85.2, 85.1, 85.1, 83.0, 82.7, 82.3, 81.6, 80.8, 80.0, 79.2, 78.8],
    20: [81.0, 82.2, 83.4, 83.7, 84.0, 84.3, 84.6, 84.9, 85.0, 85.2, 83.9, 83.6, 83.2, 82.5, 81.8, 81.1, 80.3, 79.9],
    15: [80.3, 81.5, 82.7, 83.0, 83.3, 83.5, 83.8, 84.1, 84.4, 84.7, 84.8, 84.5, 84.2, 83.4, 82.7, 82.1, 81.4, 81.1],
    10: [79.6, 80.8, 82.0, 82.2, 82.5, 82.8, 83.1, 83.4, 83.7, 84.0, 84.3, 84.7, 85.0, 84.4, 83.8, 83.2, 82.5, 82.2],
     5: [78.9, 80.0, 81.2, 81.5, 81.8, 82.0, 82.4, 82.6, 82.9, 83.3, 83.6, 84.0, 84.3, 84.3, 84.4, 84.2, 83.6, 83.3],
     0: [78.1, 79.3, 80.5, 80.8, 81.1, 81.3, 81.6, 81.9, 82.2, 82.5, 82.9, 83.2, 83.6, 83.6, 83.7, 83.7, 83.7, 83.8],
    -5: [77.4, 78.5, 79.7, 80.0, 80.3, 80.5, 80.8, 81.1, 81.4, 81.7, 82.1, 82.5, 82.8, 82.9, 82.9, 83.0, 83.0, 83.0],
   -10: [76.6, 77.8, 79.0, 79.2, 79.5, 79.8, 80.0, 80.3, 80.6, 81.0, 81.4, 81.7, 82.1, 82.2, 82.2, 82.2, 82.3, 82.3],
   -15: [75.9, 77.1, 78.2, 78.5, 78.8, 79.0, 79.2, 79.5, 79.9, 80.2, 80.6, 81.0, 81.3, 81.4, 81.5, 81.5, 81.5, 81.5],
   -20: [75.2, 76.3, 77.5, 77.7, 78.0, 78.2, 78.5, 78.8, 79.1, 79.4, 79.8, 80.2, 80.6, 80.6, 80.7, 80.7, 80.8, 80.8],
   -25: [74.4, 75.6, 76.7, 77.0, 77.2, 77.5, 77.7, 78.0, 78.3, 78.7, 79.1, 79.5, 79.8, 79.9, 79.9, 80.0, 80.0, 80.0],
   -30: [73.7, 74.8, 75.9, 76.2, 76.5, 76.7, 76.9, 77.2, 77.5, 77.9, 78.3, 78.7, 79.0, 79.1, 79.2, 79.2, 79.2, 79.3],
   -35: [72.9, 74.0, 75.1, 75.4, 75.7, 75.9, 76.2, 76.4, 76.7, 77.1, 77.5, 77.9, 78.2, 78.3, 78.4, 78.4, 78.5, 78.5],
   -40: [72.1, 73.2, 74.3, 74.6, 74.9, 75.1, 75.4, 75.7, 76.0, 76.3, 76.7, 77.1, 77.4, 77.5, 77.5, 77.6, 77.7, 77.7],
   -45: [71.4, 72.5, 73.6, 73.8, 74.1, 74.3, 74.6, 74.9, 75.2, 75.5, 75.9, 76.2, 76.6, 76.6, 76.7, 76.8, 76.9, 76.9],
   -50: [70.6, 71.7, 72.7, 73.0, 73.3, 73.5, 73.8, 74.0, 74.4, 74.7, 75.0, 75.4, 75.7, 75.8, 75.9, 76.0, 76.1, 76.1],
}



# --------------------------------------------------------------------
# PACKS OFF AND ENG ANTI-ICE ALTITUDE DELTAS
# --------------------------------------------------------------------

PACKS_OFF_DELTA = {
    'MAX': [0.5,0.5,0.6,0.6,0.7,0.8,0.8,0.9,0.9,1.0,1.0,1.0,1.1,1.2,1.4,1.6,1.7,1.8],
    'TO1': [0.5,0.5,0.6,0.6,0.7,0.8,0.8,0.9,0.9,1.0,1.0,1.0,1.1,1.2,1.4,1.6,1.7,1.8],
    'TO2': [0.5,0.5,0.6,0.6,0.7,0.8,0.8,0.9,0.9,1.0,1.0,1.0,1.1,1.2,1.3,1.6,1.7,1.7],
}

ENG_AICE_ON_DELTA = {
    'MAX': [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,-0.2,-0.6,-0.6,-0.6,-0.6,-0.6,-0.6],
    'TO1': [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,-0.2,-0.6,-0.6,-0.6,-0.5,0.0,0.0],
    'TO2': [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,-0.1,0.0,0.0,0.0,0.0,0.0,0.0],
}


# --------------------------------------------------------------------
# APPLY DELTAS
# --------------------------------------------------------------------

def _apply_altitude_deltas(n1, mode, A_ft, packs, eng_anti_ice):
    out = n1
    if packs.lower() == 'off':
        out += _interp_altitude_delta(PACKS_OFF_DELTA[mode], A_ft)
    if eng_anti_ice:
        out += _interp_altitude_delta(ENG_AICE_ON_DELTA[mode], A_ft)
    return out


# --------------------------------------------------------------------
# PUBLIC FUNCTIONS
# --------------------------------------------------------------------

def n1_max_power(A_ft, T_c, packs='on', eng_anti_ice=False):
    base = _bilinear(MAX_ROWS, A_ft, T_c)
    return _apply_altitude_deltas(base, 'MAX', A_ft, packs, eng_anti_ice)

def n1_to1(A_ft, T_c, packs='on', eng_anti_ice=False):
    base = _bilinear(TO1_ROWS, A_ft, T_c)
    return _apply_altitude_deltas(base, 'TO1', A_ft, packs, eng_anti_ice)

def n1_to2(A_ft, T_c, packs='on', eng_anti_ice=False):
    base = _bilinear(TO2_ROWS, A_ft, T_c)
    return _apply_altitude_deltas(base, 'TO2', A_ft, packs, eng_anti_ice)


# --------------------------------------------------------------------
# INFINITE FLIGHT SLIDER MAPPING
# --------------------------------------------------------------------

def slider_from_n1(n1_percent: float) -> float:
    """
    Slider = 0 → N1=20%
    Slider = 100 → N1=101%
    Linear mapping.
    """
    s = (n1_percent - 20.0) / 81.0 * 100.0
    return min(max(s, 0.0), 100.0)


# --------------------------------------------------------------------
# MASTER ENTRY POINT
# --------------------------------------------------------------------

def n1_and_slider(mode: str, A_ft: float, T_c: float,
                  packs: str='on', eng_anti_ice: bool=False):
    mode = mode.upper()
    if mode == 'MAX':
        n1 = n1_max_power(A_ft, T_c, packs, eng_anti_ice)
    elif mode == 'TO1':
        n1 = n1_to1(A_ft, T_c, packs, eng_anti_ice)
    elif mode == 'TO2':
        n1 = n1_to2(A_ft, T_c, packs, eng_anti_ice)
    else:
        raise ValueError("Mode must be one of: MAX, TO1, TO2")

    return n1, slider_from_n1(n1)
